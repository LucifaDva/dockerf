clusterby: swarm
master: icy-m-master-1
mastergroup: icy-m-master
discovery: consul://192.168.59.103:8500/testty3

machine:
    os: ubuntu-14.04-64

    cloud:
       aliyun:
          options: --engine-install-url https://get.daocloud.io/docker/ --engine-insecure-registry 123.57.88.212:5000 --swarm-image 123.57.88.212:5000/icycrystal4/swarm
          globaloptions: --native-ssh
       virtualbox:
          options: --engine-insecure-registry registry.intra.weibo.com --swarm-image registry.intra.weibo.com/icycrystal4/swarm
          globaloptions: --native-ssh
          default: true

    topology:
       # -  group: icy-m-consulcluster
       #    minnum: 1
       #    maxnum: 1
       #    cpu: 2
       #    memory: 4g
       #    disk:
       #       type: ssd
       #       capacity: 20g
       #    region: cn-beijing
       #    init: touch ~/hello
       #    driveropts:
       #    consul: false

       -  group: icy-m-master
          minnum: 1
          maxnum: 1
          cpu: 2
          memory: 4g
          disk:
             type: ssd
             capacity: 20g
          region: cn-beijing
          init: touch ~/hello
          driveropts:
          consul: false

       -  group: icy-m-frontend
          minnum: 1
          maxnum: 1
          cpu: 1
          memory: 1g
          disk:
             type: ssd
             capacity: 10240m
          region: cn-beijing
          init: touch ~/hello
          driveropts:
          consul: false

       -  group: icy-m-nginx
          minnum: 1
          maxnum: 1
          cpu: 1
          memory: 1g
          disk:
             type: ssd
             capacity: 20g
          region: cn-beijing
          init: touch ~/hello
          driveropts:
          consul: true

container:
   topology:
       - group: icy-c-nginx-{port}
         port: 8408|8409:8408
         num: 1
         image: registry.intra.weibo.com/icycrystal4/wb-nginx:0.6
         restart: false
         url: if.nginx{port}
         machine: icy-m-nginx
         volums:
            - /var:/var

       - group: icy-c-web
         port: 40000~50000:8080
         num: 1
         image: registry.intra.weibo.com/icycrystal/tomcat
         prestop: touch ~/503  # execute some shell commands on the machine, not in container, before stop the service 
         poststart: touch ~/200
         restart: true
         servicediscover: webnginx
         machine: icy-m-frontend

servicediscover:
  webnginx:
    driver: nginx-push
    upstream: discover
    container: icy-c-nginx-8408

consulcluster:
   server:
      service: weibo
      image: registry.intra.weibo.com/icycrystal4/progrium-consul
      domain: weibo
      ips: 
         - 192.168.59.103
      nodes:
         # - icy-m-consulcluster-1
         # - consulcluster-2
         # - consulcluster-3
      machine: icy-m-consulcluster
   agent:
      image: registry.intra.weibo.com/icycrystal4/progrium-consul
   registrator:
      image: registry.intra.weibo.com/icycrystal4/progrium-registrator

